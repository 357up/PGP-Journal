ARG APACHE_VERSION=""

FROM httpd:${APACHE_VERSION:+${APACHE_VERSION}}

COPY httpd.conf /usr/local/apache2/conf/httpd.conf
COPY journal.httpd.conf /usr/local/apache2/conf/extra/journal.conf

ARG MYSQL_DATABASE="login"
ARG MYSQL_USER="root"
ARG MYSQL_PASSWORD="mysql"
ARG TRUSTED_PROXIES=127.0.0.1
ARG EMAIL_USE_SMTP=false
ARG EMAIL_SMTP_HOST=smtp.example.com
ARG EMAIL_SMTP_AUTH=true
ARG EMAIL_SMTP_USERNAME=user@host
ARG EMAIL_SMTP_PASSWORD=pass
ARG EMAIL_SMTP_PORT=587
ARG EMAIL_SMTP_ENCRYPTION=tls
ARG EMAIL_PASSWORDRESET_FROM=no-reply@example.com
ARG EMAIL_PASSWORDRESET_FROM_NAME="My Journal"
ARG EMAIL_PASSWORDRESET_SUBJECT
ARG EMAIL_PASSWORDRESET_CONTENT
ARG EMAIL_VERIFICATION_FROM=no-reply@example.com
ARG EMAIL_VERIFICATION_FROM_NAME="My Journal"
ARG EMAIL_VERIFICATION_SUBJECT
ARG EMAIL_VERIFICATION_CONTENT
ARG COOKIE_RUNTIME=1209600
ARG COOKIE_DOMAIN=.journal.example.com
ARG COOKIE_SECRET_KEY="1gp@TMPS{+$78sfpMJFe-92s"

RUN export CONFIG_FILE=/usr/local/apache2/conf/extra/journal.conf \
    && echo "SetEnv MYSQL_DATABASE ${MYSQL_DATABASE}" >> $CONFIG_FILE \
    && echo "SetEnv MYSQL_USER ${MYSQL_USER}" >> $CONFIG_FILE \
    && echo "SetEnv MYSQL_PASSWORD \"${MYSQL_PASSWORD}\"" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_USE_SMTP ${EMAIL_USE_SMTP}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_SMTP_HOST ${EMAIL_SMTP_HOST}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_SMTP_AUTH ${EMAIL_SMTP_AUTH}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_SMTP_USERNAME ${EMAIL_SMTP_USERNAME}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_SMTP_PASSWOED \"${EMAIL_SMTP_PASSWORD}\"" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_SMTP_PORT ${EMAIL_SMTP_PORT}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_SMTP_ENCRYPTION ${EMAIL_SMTP_ENCRYPTION}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_PASSWORDRESET_FROM ${EMAIL_PASSWORDRESET_FROM}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_PASSWORDRESET_FROM_NAME ${EMAIL_PASSWORDRESET_FROM_NAME}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_PASSWORDRESET_SUBJECT ${EMAIL_PASSWORDRESET_SUBJECT}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_PASSWORDRESET_CONTENT ${EMAIL_PASSWORDRESET_CONTENT}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_VERIFICATION_FROM ${EMAIL_VERIFICATION_FROM}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_VERIFICATION_FROM_NAME ${EMAIL_VERIFICATION_FROM_NAME}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_VERIFICATION_SUBJECT ${EMAIL_VERIFICATION_SUBJECT}" >> $CONFIG_FILE \
    && echo "SetEnv EMAIL_VERIFICATION_CONTENT ${EMAIL_VERIFICATION_CONTENT}" >> $CONFIG_FILE \
    && echo "SetEnv TRUSTED_PROXIES ${TRUSTED_PROXIES}" >> $CONFIG_FILE \
    && echo "SetEnv COOKIE_RUNTIME ${COOKIE_RUNTIME}" >> $CONFIG_FILE \
    && echo "SetEnv COOKIE_DOMAIN ${COOKIE_DOMAIN}" >> $CONFIG_FILE \
    && echo "SetEnv COOKIE_SECRET_KEY ${COOKIE_SECRET_KEY}" >> $CONFIG_FILE

WORKDIR /var/www

RUN mkdir journal && useradd -d /var/www/journal -s /sbin/nologin journal

WORKDIR /var/www/journal

RUN mkdir tmp webspaceroot && chown -R journal: .
